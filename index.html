<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>CRM — Редактировать занятия</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
  body{background:#f5f8fb; font-family:Inter,system-ui,Arial; padding:14px;}
  .card{border-radius:12px; box-shadow:0 8px 30px rgba(20,30,60,0.04); margin-bottom:12px;}
  .child-row{display:flex;justify-content:space-between;align-items:center;padding:10px;border-bottom:1px solid #eef3f7;}
  .child-row:last-child{border-bottom:0;}
  .controls button{width:36px;height:36px;border-radius:8px;border:0;font-weight:700;}
  .controls .minus{background:#ffe6e6;color:#b20000;}
  .controls .plus{background:#e6fff0;color:#007a33;}
  .small-muted{color:#6c757d;font-size:0.92rem;}
</style>
</head>
<body>
  <div class="container" style="max-width:760px;">
    <h3 class="mb-3">CRM — Быстро поправить количество занятий</h3>

    <div class="card p-3 mb-3">
      <div class="d-flex gap-2">
        <button id="btnRefresh" class="btn btn-outline-primary">Обновить список</button>
        <input id="search" class="form-control" placeholder="Поиск по имени или ID" style="max-width:320px"/>
      </div>
      <div class="small-muted mt-2">Нажмите + чтобы прибавить занятие, − чтобы списать. Изменения сохраняются мгновенно.</div>
    </div>

    <div class="card p-0" id="childrenCard">
      <div id="childrenList" style="padding:8px;color:#777">Нажмите "Обновить список"</div>
    </div>
  </div>

<script>
const gasUrl = 'https://script.google.com/macros/s/AKfycbyI17STyEsL6vYDBX1d98YElOk9O7KWTwMUL7DxOulDzSkgPXLASnNCfsA1GvNWfM_fEA/exec'; // <- замени на свой
const btnRefresh = document.getElementById('btnRefresh');
const childrenList = document.getElementById('childrenList');
const searchEl = document.getElementById('search');

let allChildren = [];

btnRefresh.addEventListener('click', loadChildren);
searchEl.addEventListener('input', renderChildren);

async function loadChildren(){
  childrenList.innerHTML = '<div style="padding:12px;color:#666">Загрузка...</div>';
  try {
    const resp = await fetch(`${gasUrl}?action=getAllChildren`);
    const data = await resp.json();
    if (!data.success) { childrenList.innerHTML = '<div style="padding:12px;color:#c00">Ошибка загрузки</div>'; return; }
    allChildren = data.children || [];
    renderChildren();
  } catch (err) {
    console.error(err);
    childrenList.innerHTML = '<div style="padding:12px;color:#c00">Ошибка сети</div>';
  }
}

function renderChildren(){
  const q = (searchEl.value || '').toLowerCase().trim();
  const list = allChildren.filter(c => !q || c.childName.toLowerCase().includes(q) || c.telegramID.includes(q));
  if (list.length === 0) { childrenList.innerHTML = '<div style="padding:12px;color:#666">Ничего не найдено</div>'; return; }
  childrenList.innerHTML = list.map(c => {
    return `<div class="child-row" data-telegram="${escapeHtml(c.telegramID)}" data-name="${escapeHtml(c.childName)}">
      <div>
        <div style="font-weight:700">${escapeHtml(c.childName)}</div>
        <div class="small-muted">ID: ${escapeHtml(c.telegramID)} • Осталось: <span class="remaining">${Number(c.remaining)}</span></div>
      </div>
      <div class="controls" style="display:flex;gap:8px;align-items:center">
        <button class="minus" title="Убавить">−</button>
        <button class="plus" title="Прибавить">+</button>
      </div>
    </div>`;
  }).join('');
  // attach handlers
  document.querySelectorAll('.child-row').forEach(row => {
    const minus = row.querySelector('.minus');
    const plus = row.querySelector('.plus');
    minus.addEventListener('click', () => changeRemaining(row, -1));
    plus.addEventListener('click', () => changeRemaining(row, +1));
  });
}

async function changeRemaining(row, delta){
  const telegramID = row.getAttribute('data-telegram');
  const childName = row.getAttribute('data-name');
  const remEl = row.querySelector('.remaining');
  let current = Number(remEl.innerText || 0);
  // optimistic UI
  const newVal = Math.max(0, current + delta);
  remEl.innerText = newVal;

  // choose action
  const action = delta > 0 ? 'incRemaining' : 'decRemaining';
  // send as form-urlencoded to avoid preflight
  const params = new URLSearchParams();
  params.append('action', action);
  params.append('telegramID', telegramID);
  params.append('childName', childName);

  try {
    const resp = await fetch(gasUrl, {
      method: 'POST',
      headers: { 'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8' },
      body: params.toString()
    });
    const result = await resp.json();
    if (!result.success) {
      // rollback UI
      remEl.innerText = current;
      alert(result.message || 'Ошибка изменения');
    } else {
      remEl.innerText = Number(result.remaining);
      // update local cache
      const idx = allChildren.findIndex(c => c.telegramID === telegramID && c.childName === childName);
      if (idx >= 0) allChildren[idx].remaining = Number(result.remaining);
    }
  } catch (err) {
    console.error(err);
    remEl.innerText = current;
    alert('Ошибка сети');
  }
}

function escapeHtml(s){ if (s === undefined || s === null) return ''; return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'","&#039;"); }

</script>
</body>
</html>
