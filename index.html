<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>CRM — занятия и группы (обновлённая)</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
  body{background:#f5f8fb; font-family:Inter,system-ui,Arial; padding:14px;}
  .card{border-radius:12px; box-shadow:0 8px 30px rgba(20,30,60,0.04); margin-bottom:12px;}
  .groups { display:flex; gap:8px; flex-wrap:wrap; margin-bottom:8px; }
  .group-bucket { min-width:150px; flex:1; border-radius:10px; background:#fff; border:1px dashed transparent; padding:8px; }
  .group-bucket.active { border-color: rgba(43,140,255,0.25); box-shadow: 0 6px 18px rgba(43,140,255,0.06); }
  .group-title { font-weight:700; margin-bottom:8px; font-size:0.95rem; }
  .child-row{display:flex;justify-content:space-between;align-items:center;padding:8px;border-bottom:1px solid #eef3f7; cursor:grab; background:transparent; border-radius:8px;}
  .child-row.dragging{opacity:0.5; transform:scale(0.98);}
  .child-left { max-width:60%; }
  .controls { display:flex; gap:6px; align-items:center; }
  .btn-plus { background:#e6fff0; color:#007a33; border:0; border-radius:8px; width:36px; height:36px; font-weight:700; }
  .btn-minus { background:#ffe6e6; color:#b20000; border:0; border-radius:8px; width:36px; height:36px; font-weight:700; }
  .btn-plus-extra { background:#e6f7ff; color:#006fa6; border:0; border-radius:8px; width:36px; height:36px; font-weight:700; }
  .btn-minus-extra { background:#fff4e6; color:#b25a00; border:0; border-radius:8px; width:36px; height:36px; font-weight:700; }
  .small-muted{color:#6c757d;font-size:0.92rem;}
  .bucket-body { min-height:80px; max-height:420px; overflow:auto; padding:6px; }
  .search { max-width:360px; }
  @media(max-width:700px){ .groups { flex-direction:column; } .child-left{ max-width:100%; } }
</style>
</head>
<body>
  <div class="container" style="max-width:980px;">
    <h3 class="mb-3">CRM — занятия и группы (обновлённая)</h3>

    <div class="card p-3 mb-3">
      <div class="d-flex gap-2 flex-wrap">
        <button id="btnRefresh" class="btn btn-outline-primary">Обновить список</button>
        <input id="search" class="form-control search" placeholder="Поиск по имени или ID" />
        <select id="groupFilter" class="form-select" style="max-width:220px;">
          <option value="">Показать: Все</option>
          <option value="unassigned">Нераспределённые</option>
          <option value="novye_shkolniki">Новые школьники</option>
          <option value="doshkolniki">Дошкольники</option>
          <option value="starii">Старшая группа</option>
        </select>
      </div>
      <div class="small-muted mt-2">Перетаскивайте карточки между группами. Кнопки рядом меняют количество занятий и отработок.</div>
    </div>

    <!-- groups -->
    <div class="groups" id="groupsWrap">
      <!-- buckets генерируются динамически -->
    </div>

    <div class="card p-3">
      <div class="d-flex gap-2">
        <button id="btnExport" class="btn btn-outline-secondary">Экспорт CSV</button>
        <div class="small-muted ms-auto">Данные синхронизируются при нажатии +/− или при перемещении.</div>
      </div>
    </div>
  </div>

<script>
const gasUrl = 'https://script.google.com/macros/s/AKfycbyI17STyEsL6vYDBX1d98YElOk9O7KWTwMUL7DxOulDzSkgPXLASnNCfsA1GvNWfM_fEA/exec'; // <- замени на свой

let allChildren = []; // {telegramID, childName, remaining, extra, group}
const groupsList = [
  { id: '', title: 'Все' },
  { id: 'unassigned', title: 'Нераспределённые' },
  { id: 'novye_shkolniki', title: 'Новые школьники' },
  { id: 'doshkolniki', title: 'Дошкольники' },
  { id: 'starii', title: 'Старшая группа' }
];

const btnRefresh = document.getElementById('btnRefresh');
const childrenWrap = document.getElementById('groupsWrap');
const searchEl = document.getElementById('search');
const groupFilter = document.getElementById('groupFilter');
btnRefresh.addEventListener('click', loadChildren);
searchEl.addEventListener('input', renderBuckets);
groupFilter.addEventListener('change', renderBuckets);
document.getElementById('btnExport').addEventListener('click', exportCSV);

// load all children from server (getAllChildren)
async function loadChildren(){
  childrenWrap.innerHTML = '<div class="card p-3">Загрузка...</div>';
  try {
    const resp = await fetch(`${gasUrl}?action=getAllChildren`);
    const data = await resp.json();
    if (!data.success) { childrenWrap.innerHTML = '<div class="card p-3 text-danger">Ошибка загрузки</div>'; return; }
    // normalize: ensure group and extra exist
    allChildren = (data.children || []).map(c => ({
      telegramID: c.telegramID || '',
      childName: c.childName || '',
      remaining: Number(c.remaining || 0),
      extra: Number(c.extra || 0),
      group: (c.group || '').trim()
    }));
    renderBuckets();
  } catch (err) {
    console.error(err);
    childrenWrap.innerHTML = '<div class="card p-3 text-danger">Ошибка сети</div>';
  }
}

// render buckets (All + Unassigned + groups)
function renderBuckets(){
  const q = (searchEl.value || '').toLowerCase().trim();
  const filter = groupFilter.value; // '' or specific or 'unassigned'
  childrenWrap.innerHTML = groupsList.map(g => {
    // select items for this bucket
    const list = allChildren.filter(c => {
      // groupFilter applied: if filter set, only show that bucket (unless filter === '')
      if (filter) {
        if (filter === 'unassigned') {
          if (c.group && c.group !== '') return false;
        } else {
          if (c.group !== filter) return false;
        }
      }
      // bucket-specific filtering: if bucket.id === '' -> either show all OR if groupFilter empty we show all; 
      // For specific bucket (like novye_shkolniki) show those with c.group === bucket.id
      if (g.id === 'unassigned') {
        if (c.group && c.group !== '') return false;
      } else if (g.id) {
        if (c.group !== g.id) return false;
      } // else g.id === '' means "All" - include everything (subject to search/filter above)

      // search filter
      if (q && !(String(c.childName).toLowerCase().includes(q) || String(c.telegramID).includes(q))) return false;
      return true;
    });
    const count = list.length;
    // bucket id used for element id; for '' (All) use 'all'
    const bucketId = g.id || 'all';
    return `<div class="group-bucket card" data-group="${g.id}">
      <div class="group-title">${g.title} ${g.id ? `(${count})` : `(${count})`}</div>
      <div class="bucket-body" id="bucket-${bucketId}">${list.map(c => renderChildHTML(c)).join('') || '<div style="padding:8px;color:#777">Пусто</div>'}</div>
    </div>`;
  }).join('');
  attachDragAndDrop();
  attachControlHandlers();
}

function renderChildHTML(c){
  return `<div class="child-row" draggable="true" data-telegram="${escapeAttr(c.telegramID)}" data-name="${escapeAttr(c.childName)}" data-group="${escapeAttr(c.group || '')}">
    <div class="child-left">
      <div style="font-weight:700">${escapeHtml(c.childName)}</div>
      <div class="small-muted">ID: ${escapeHtml(c.telegramID)} • Осталось: <span class="remaining">${Number(c.remaining)}</span> • Отработки: <span class="extra">${Number(c.extra)}</span></div>
    </div>
    <div class="controls">
      <button class="btn-plus-extra" title="Добавить отработку">+E</button>
      <button class="btn-minus-extra" title="Убрать отработку">−E</button>
      <button class="btn-plus" title="Добавить занятие">+</button>
      <button class="btn-minus" title="Убавить занятие">−</button>
    </div>
  </div>`;
}

// attach + / - handlers
function attachControlHandlers(){
  document.querySelectorAll('.child-row').forEach(row => {
    const plus = row.querySelector('.btn-plus');
    const minus = row.querySelector('.btn-minus');
    const plusE = row.querySelector('.btn-plus-extra');
    const minusE = row.querySelector('.btn-minus-extra');
    plus.onclick = () => changeRemaining(row, +1);
    minus.onclick = () => changeRemaining(row, -1);
    plusE.onclick = () => changeExtra(row, +1);
    minusE.onclick = () => changeExtra(row, -1);
  });
}

// optimistic UI + server update for remaining
async function changeRemaining(row, delta){
  const telegram = row.getAttribute('data-telegram');
  const name = row.getAttribute('data-name');
  const remEl = row.querySelector('.remaining');
  const cur = Number(remEl.innerText || 0);
  const newVal = Math.max(0, cur + delta);
  remEl.innerText = newVal; // optimistic

  const action = delta > 0 ? 'incRemaining' : 'decRemaining';
  const params = new URLSearchParams();
  params.append('action', action);
  params.append('telegramID', telegram);
  params.append('childName', name);

  try {
    const resp = await fetch(gasUrl, {
      method: 'POST',
      headers: {'Content-Type':'application/x-www-form-urlencoded;charset=UTF-8'},
      body: params.toString()
    });
    const res = await resp.json();
    if (!res.success) {
      remEl.innerText = cur;
      alert(res.message || 'Ошибка изменения');
    } else {
      remEl.innerText = Number(res.remaining);
      const idx = allChildren.findIndex(c => c.telegramID === telegram && c.childName === name);
      if (idx >= 0) allChildren[idx].remaining = Number(res.remaining);
    }
  } catch (err) {
    console.error(err);
    remEl.innerText = cur;
    alert('Ошибка сети');
  }
}

// optimistic UI + server update for extra
async function changeExtra(row, delta){
  const telegram = row.getAttribute('data-telegram');
  const name = row.getAttribute('data-name');
  const extraEl = row.querySelector('.extra');
  const cur = Number(extraEl.innerText || 0);
  const newVal = Math.max(0, cur + delta);
  extraEl.innerText = newVal;

  const action = delta > 0 ? 'incExtra' : 'decExtra';
  const params = new URLSearchParams();
  params.append('action', action);
  params.append('telegramID', telegram);
  params.append('childName', name);

  try {
    const resp = await fetch(gasUrl, {
      method: 'POST',
      headers: {'Content-Type':'application/x-www-form-urlencoded;charset=UTF-8'},
      body: params.toString()
    });
    const res = await resp.json();
    if (!res.success) {
      extraEl.innerText = cur;
      alert(res.message || 'Ошибка изменения отработки');
    } else {
      extraEl.innerText = Number(res.extra);
      const idx = allChildren.findIndex(c => c.telegramID === telegram && c.childName === name);
      if (idx >= 0) allChildren[idx].extra = Number(res.extra);
    }
  } catch (err) {
    console.error(err);
    extraEl.innerText = cur;
    alert('Ошибка сети');
  }
}

// Drag & Drop
function attachDragAndDrop(){
  const rows = document.querySelectorAll('.child-row');
  rows.forEach(r => {
    r.addEventListener('dragstart', dragStart);
    r.addEventListener('dragend', dragEnd);
  });

  const buckets = document.querySelectorAll('.group-bucket');
  buckets.forEach(b => {
    b.addEventListener('dragover', e => { e.preventDefault(); b.classList.add('active'); });
    b.addEventListener('dragleave', () => b.classList.remove('active'));
    b.addEventListener('drop', e => {
      e.preventDefault();
      b.classList.remove('active');
      const tg = e.dataTransfer.getData('text/tg');
      const name = e.dataTransfer.getData('text/name');
      const toGroup = b.getAttribute('data-group') || '';
      const el = document.querySelector(`.child-row[data-telegram="${cssEscapeAttr(tg)}"][data-name="${cssEscapeAttr(name)}"]`);
      if (!el) return;
      // append element to bucket body
      b.querySelector('.bucket-body').appendChild(el);
      el.setAttribute('data-group', toGroup);
      // call API to setGroup
      setGroupAPI(tg, name, toGroup, el);
    });
  });
}

function dragStart(e){
  this.classList.add('dragging');
  const tg = this.getAttribute('data-telegram');
  const name = this.getAttribute('data-name');
  e.dataTransfer.setData('text/tg', tg);
  e.dataTransfer.setData('text/name', name);
}
function dragEnd(){ this.classList.remove('dragging'); }

function cssEscapeAttr(s){
  // for selector use, but we used attribute equals search, so just return the raw string
  return s.replace(/"/g,'\\"');
}

// API call to set group
async function setGroupAPI(telegram, childName, group, el){
  try {
    const params = new URLSearchParams();
    params.append('action','setGroup');
    params.append('telegramID', telegram);
    params.append('childName', childName);
    params.append('group', group);
    const resp = await fetch(gasUrl, {
      method:'POST',
      headers: {'Content-Type':'application/x-www-form-urlencoded;charset=UTF-8'},
      body: params.toString()
    });
    const res = await resp.json();
    if (!res.success) {
      alert(res.message || 'Ошибка при смене группы');
      loadChildren();
    } else {
      const idx = allChildren.findIndex(c => c.telegramID === telegram && c.childName === childName);
      if (idx >= 0) allChildren[idx].group = group;
      el.style.transition = 'background-color .25s';
      el.style.backgroundColor = 'rgba(43,140,255,0.06)';
      setTimeout(()=> el.style.backgroundColor = 'transparent', 600);
    }
  } catch (err) {
    console.error(err);
    alert('Ошибка сети при смене группы');
    loadChildren();
  }
}

// Export CSV (all children)
function exportCSV(){
  const rows = allChildren.map(c => [c.telegramID, c.childName, c.remaining, c.extra, c.group]);
  let csv = 'telegramID,childName,remaining,extra,group\n' + rows.map(r => r.map(cell => `"${String(cell).replace(/"/g,'""')}"`).join(',')).join('\n');
  const blob = new Blob([csv], { type:'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = `children_all.csv`; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
}

// helpers
function escapeHtml(s){ if (s === undefined || s === null) return ''; return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'",'&#039;'); }
function escapeAttr(s){ return (s === undefined || s === null) ? '' : String(s).replace(/"/g,'&quot;'); }

</script>
</body>
</html>
