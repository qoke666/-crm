<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>CRM — расписание и группы</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
  body{background:#f5f8fb;font-family:Inter,system-ui,Arial;padding:14px;}
  .card{border-radius:12px;box-shadow:0 8px 30px rgba(20,30,60,0.04);margin-bottom:12px;}
  .tabs{display:flex;gap:8px;margin-bottom:12px;}
  .tab button{padding:8px 12px;border-radius:8px;border:1px solid #e6eef6;background:#fff;}
  .tab button.active{background:linear-gradient(90deg,#2B8CFF,#6ec3ff);color:#fff;border-color:#2B8CFF;}
  .day-block{background:#fff;padding:12px;border-radius:10px;border:1px solid #eef6ff;margin-bottom:8px;}
  .event-row{display:flex;justify-content:space-between;align-items:center;padding:8px;border-radius:8px;border:1px solid #f0f4fb;margin-bottom:6px;}
  .btn-ghost{background:transparent;border:1px solid rgba(10,20,40,0.06);padding:6px 10px;border-radius:8px;}
  .btn-primary{background:#2B8CFF;border-color:#2B8CFF;}
</style>
</head>
<body>
  <div class="container" style="max-width:980px;">
    <h3>CRM — расписание</h3>
    <div class="card p-3">
      <div style="display:flex;gap:8px;align-items:center;">
        <div class="tabs" id="weekdayTabs"></div>
        <div style="margin-left:auto">
          <button id="btnRefresh" class="btn btn-outline-primary">Обновить</button>
        </div>
      </div>
      <div id="scheduleEditor" style="margin-top:12px"></div>
    </div>
    <div class="card p-3">
      <h5>Добавить событие</h5>
      <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px;">
        <select id="evWeekday" class="form-select" style="width:160px;">
          <option value="1">Понедельник</option>
          <option value="2">Вторник</option>
          <option value="3">Среда</option>
          <option value="4">Четверг</option>
          <option value="5">Пятница</option>
          <option value="6">Суббота</option>
          <option value="0">Воскресенье</option>
        </select>
        <input id="evGroup" placeholder="Группа (пример: doshkolniki)" class="form-control" style="width:220px;" />
        <input id="evTime" placeholder="Время (пример: 18:30 — 19:30)" class="form-control" style="width:220px;" />
        <input id="evNote" placeholder="Заметка (опционально)" class="form-control" style="width:300px;" />
        <button id="btnAddEvent" class="btn btn-primary">Добавить</button>
      </div>
    </div>
  </div>

<script>
const gasUrl = 'https://script.google.com/macros/s/AKfycbyI17STyEsL6vYDBX1d98YElOk9O7KWTwMUL7DxOulDzSkgPXLASnNCfsA1GvNWfM_fEA/exec'; // <- вставь свой
const WEEKDAYS = {0:'Воскресенье',1:'Понедельник',2:'Вторник',3:'Среда',4:'Четверг',5:'Пятница',6:'Суббота'};
let schedule = []; // массив записей из сервера

document.getElementById('btnRefresh').addEventListener('click', loadSchedule);
document.getElementById('btnAddEvent').addEventListener('click', addEvent);

// build weekday tabs
const tabsWrap = document.getElementById('weekdayTabs');
[1,2,3,4,5,6,0].forEach(w => {
  const btn = document.createElement('button');
  btn.className = 'tab btn-ghost';
  btn.innerText = WEEKDAYS[w];
  btn.dataset.w = w;
  btn.onclick = () => {
    document.querySelectorAll('#weekdayTabs .tab').forEach(t=>t.classList.remove('active'));
    btn.classList.add('active');
    renderDay(w);
  };
  tabsWrap.appendChild(btn);
});
// activate today
const todayW = (new Date()).getDay();
const todayBtn = Array.from(tabsWrap.children).find(b => b.dataset.w == todayW);
if (todayBtn) { todayBtn.classList.add('active'); }

// load schedule from server
async function loadSchedule(){
  document.getElementById('scheduleEditor').innerHTML = '<div>Загрузка...</div>';
  try {
    const resp = await fetch(gasUrl + '?action=getSchedule');
    const data = await resp.json();
    if (!data.success) return document.getElementById('scheduleEditor').innerHTML = '<div class="text-danger">Ошибка загрузки</div>';
    schedule = data.schedule || [];
    renderDay(todayW);
  } catch (err) {
    console.error(err);
    document.getElementById('scheduleEditor').innerHTML = '<div class="text-danger">Ошибка сети</div>';
  }
}
loadSchedule();

function renderDay(weekday) {
  const container = document.getElementById('scheduleEditor');
  const items = schedule.filter(s => Number(s.weekday) === Number(weekday));
  container.innerHTML = `<h5 style="margin-bottom:10px">${WEEKDAYS[weekday]}</h5>`;
  if (!items.length) {
    container.innerHTML += '<div class="day-block">Нет событий</div>';
    return;
  }
  const block = document.createElement('div');
  items.forEach(ev => {
    const row = document.createElement('div');
    row.className = 'event-row';
    row.innerHTML = `<div><div style="font-weight:700">${escapeHtml(ev.group || '—')}</div><div style="color:#6c757d">${escapeHtml(ev.time || '')} ${ev.note? ' • '+escapeHtml(ev.note):''}</div></div>
      <div style="display:flex;gap:8px"><button class="btn-ghost" data-id="${ev.id}" onclick="editEvent('${ev.id}')">Править</button><button class="btn-ghost" data-id="${ev.id}" onclick="deleteEvent('${ev.id}')">Удалить</button><button class="btn btn-primary" data-id="${ev.group}" onclick="notifyGroup('${escapeJs(ev.group)}')">Уведомить группу</button></div>`;
    block.appendChild(row);
  });
  container.appendChild(block);
}

function escapeHtml(s){ if (!s) return ''; return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
function escapeJs(s){ return (s||'').replace(/'/g,"\\'").replace(/"/g,'\\"'); }

// add
async function addEvent(){
  const weekday = document.getElementById('evWeekday').value;
  const group = document.getElementById('evGroup').value.trim();
  const time = document.getElementById('evTime').value.trim();
  const note = document.getElementById('evNote').value.trim();
  if (!group || !time) return alert('Заполните группу и время');
  try {
    const body = new URLSearchParams();
    body.append('action','setSchedule');
    body.append('mode','add');
    body.append('weekday', weekday);
    body.append('group', group);
    body.append('time', time);
    body.append('note', note);
    const resp = await fetch(gasUrl, { method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded;charset=UTF-8'}, body: body.toString() });
    const res = await resp.json();
    if (res.success) {
      alert('Добавлено');
      document.getElementById('evGroup').value=''; document.getElementById('evTime').value=''; document.getElementById('evNote').value='';
      await loadSchedule();
    } else alert(res.message||'Ошибка');
  } catch (err) { console.error(err); alert('Ошибка сети'); }
}

// edit (open prompt)
window.editEvent = async function(id) {
  const ev = schedule.find(s=>s.id===id);
  if (!ev) return alert('Событие не найдено');
  const newGroup = prompt('Группа', ev.group) || ev.group;
  const newTime = prompt('Время', ev.time) || ev.time;
  const newNote = prompt('Заметка', ev.note || '') || ev.note || '';
  try {
    const body = new URLSearchParams();
    body.append('action','setSchedule');
    body.append('mode','update');
    body.append('id', id);
    body.append('weekday', ev.weekday);
    body.append('group', newGroup);
    body.append('time', newTime);
    body.append('note', newNote);
    const resp = await fetch(gasUrl, { method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded;charset=UTF-8'}, body: body.toString() });
    const res = await resp.json();
    if (res.success) { alert('Сохранено'); await loadSchedule(); } else alert(res.message||'Ошибка');
  } catch (err) { console.error(err); alert('Ошибка сети'); }
};

// delete
window.deleteEvent = async function(id) {
  if (!confirm('Удалить это событие?')) return;
  try {
    const body = new URLSearchParams();
    body.append('action','setSchedule');
    body.append('mode','delete');
    body.append('id', id);
    const resp = await fetch(gasUrl, { method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded;charset=UTF-8'}, body: body.toString() });
    const res = await resp.json();
    if (res.success) { alert('Удалено'); await loadSchedule(); } else alert(res.message||'Ошибка');
  } catch (err) { console.error(err); alert('Ошибка сети'); }
};

// notify group (send message to parents of that group)
window.notifyGroup = async function(group) {
  if (!group) return alert('Пустая группа');
  const message = prompt('Сообщение для группы ' + group, 'В расписании произошли изменения. Проверьте новое время занятий.');
  if (message === null) return;
  try {
    const body = new URLSearchParams();
    body.append('action','notifyGroupChange');
    body.append('group', group);
    body.append('message', message);
    const resp = await fetch(gasUrl, { method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded;charset=UTF-8'}, body: body.toString() });
    const res = await resp.json();
    if (res.success) {
      alert('Уведомлено: ' + res.count);
    } else {
      alert(res.message || 'Ошибка отправки уведомлений');
    }
  } catch (err) { console.error(err); alert('Ошибка сети'); }
};
</script>
</body>
</html>
