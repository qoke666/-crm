<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>CRM — Посещаемость · Расписание · Распределение</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
  :root{--accent:#2B8CFF;--muted:#6c757d;--bg:#f6f8fb;}
  html,body{height:100%;margin:0;background:var(--bg);font-family:Inter,system-ui,Arial;padding:12px}
  .wrap{max-width:800px;margin:0 auto}
  .top{display:flex;gap:12px;align-items:center;margin-bottom:12px;flex-wrap:wrap}
  h2{margin:0;font-weight:700}
  .tabs{display:flex;gap:8px;flex-wrap:wrap}
  .tab-btn{padding:8px 14px;border-radius:10px;border:1px solid rgba(10,20,40,0.06);background:#fff;cursor:pointer;font-weight:600}
  .tab-btn.active{background:linear-gradient(90deg,var(--accent),#6ec3ff);color:#fff;border-color:var(--accent)}
  .card{background:#fff;border-radius:12px;padding:14px;box-shadow:0 8px 30px rgba(20,30,60,0.04);margin-bottom:12px}
  .row-gap{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .small-muted{color:var(--muted);font-size:14px}
  /* Attendance list */
  .student-row{display:flex;justify-content:space-between;align-items:center;padding:10px;border-radius:10px;border:1px solid #eef4fb;margin-bottom:8px;background:linear-gradient(180deg,#fff,#fbfdff)}
  .student-left{display:flex;gap:12px;align-items:center;min-width:0}
  .initials{width:44px;height:44px;border-radius:8px;background:linear-gradient(135deg,#ffd89b,#ffb199);display:flex;align-items:center;justify-content:center;font-weight:700;flex-shrink:0}
  .switch { cursor:pointer; padding:6px 10px;border-radius:8px;border:1px solid rgba(10,20,40,0.06); background:#fff }
  .small-info{font-size:13px;color:var(--muted)}
  /* controls for +/- */
  .counter-btn { 
    padding:6px 10px;border-radius:8px;border:1px solid rgba(10,20,40,0.06); background:#fff; cursor:pointer; font-weight:700; 
    transition: transform 0.1s ease;
  }
  .counter-btn:active { transform: scale(0.95); }
  .counter-col { display:flex; gap:6px; align-items:center; }
  /* schedule */
  .event-row{display:flex;justify-content:space-between;align-items:center;padding:8px;border-radius:8px;border:1px solid #f0f4fb;margin-bottom:6px}
  .btn-ghost{background:transparent;border:1px solid rgba(10,20,40,0.06);padding:6px 10px;border-radius:8px}
  .btn-main{background:var(--accent);color:#fff;border:0;padding:8px 12px;border-radius:10px}
  input.select, select.select { padding:8px;border-radius:10px;border:1px solid rgba(10,20,40,0.06); width: 100%; }
  .time-inputs { display: flex; gap: 8px; align-items: center; }
  .time-inputs input { min-width: 100px; }
  .day-section { margin-bottom: 16px; }
  .day-header { font-weight: 700; margin-bottom: 8px; }
  .event-row { display: flex; flex-direction: column; gap: 8px; align-items: stretch; }
  .event-actions { display: flex; gap: 8px; justify-content: flex-end; }
  .event-info { display: flex; flex-direction: column; }
  @media(max-width:768px){
    body { padding: 12px; }
    .wrap { padding: 0 12px; }
    .student-left { min-width: 0; }
    .initials { width:40px;height:40px }
    .row-gap { flex-direction:column; align-items:stretch }
    .time-inputs { flex-direction: column; }
    .counter-col { flex-direction: column; gap: 4px; }
    .student-row { flex-direction: column; gap: 8px; align-items: stretch; }
    .event-row { padding: 12px; }
    .event-actions { justify-content: space-between; }
  }
</style>
</head>
<body>
<div class="wrap">
  <div class="top">
    <div>
      <h2>CRM — тренер</h2>
      <div class="small-muted">Посещаемость • Распределение • Расписание</div>
    </div>
  </div>

  <div class="tabs" style="margin-bottom:12px">
    <button class="tab-btn active" data-tab="attendance">Посещаемость</button>
    <button class="tab-btn" data-tab="distribution">Распределение</button>
    <button class="tab-btn" data-tab="schedule">Расписание</button>
  </div>

  <!-- ATTENDANCE -->
  <div id="attendance" class="card">
    <div class="row-gap" style="margin-bottom:12px">
      <div style="flex:1">
        <label style="font-weight:700">Группа</label><br>
        <select id="attGroup" class="select">
          <option value="">— Все группы —</option>
          <option value="Новые школьники">Новые школьники</option>
          <option value="Дошкольники">Дошкольники</option>
          <option value="Старшая группа">Старшая группа</option>
          <option value="Нераспределённые">Нераспределённые</option>
        </select>
      </div>

      <div style="display:flex;gap:8px;align-items:flex-end">
        <button id="loadGroupStudents" class="btn-main">Загрузить</button>
      </div>
    </div>

    <div id="attendanceList">
      <div class="small-muted">Нажмите «Загрузить», чтобы подтянуть детей выбранной группы.</div>
    </div>
  </div>

  <!-- DISTRIBUTION -->
  <div id="distribution" class="card" style="display:none">
    <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px;align-items:center">
      <div style="flex:1;min-width:180px">
        <label style="font-weight:700">Поиск</label><br>
        <input id="distSearch" class="select" placeholder="По имени или ID" />
      </div>
      <div>
        <button id="loadAllChildren" class="btn-main">Загрузить</button>
      </div>
    </div>

    <div id="distributionList">
      <div class="small-muted">Загрузите список детей, чтобы распределить по группам.</div>
    </div>
  </div>

  <!-- SCHEDULE -->
  <div id="schedule" class="card" style="display:none">
    <div class="row-gap" style="margin-bottom:12px">
      <div style="flex:1">
        <label style="font-weight:700">День недели</label><br>
        <select id="schWeekday" class="select">
          <option value="1">Понедельник</option>
          <option value="2">Вторник</option>
          <option value="3">Среда</option>
          <option value="4">Четверг</option>
          <option value="5">Пятница</option>
          <option value="6">Суббота</option>
          <option value="0">Воскресенье</option>
        </select>
      </div>
      <div style="flex:1">
        <label style="font-weight:700">Группа</label><br>
        <select id="schGroup" class="select">
          <option value="Новые школьники">Новые школьники</option>
          <option value="Дошкольники">Дошкольники</option>
          <option value="Старшая группа">Старшая группа</option>
          <option value="Нераспределённые">Нераспределённые / Другое</option>
        </select>
      </div>
      <div style="flex:1">
        <label style="font-weight:700">Время</label><br>
        <div class="time-inputs">
          <input id="schStartTime" type="time" class="select" value="17:30" />
          <span>—</span>
          <input id="schEndTime" type="time" class="select" value="18:30" />
        </div>
      </div>
      <div style="flex:1">
        <label style="font-weight:700">Заметка</label><br>
        <input id="schNote" type="text" class="select" placeholder="Опционально" />
      </div>
    </div>
    <div style="display:flex;gap:8px;align-items:center;justify-content:space-between;margin-bottom:12px">
      <label style="display:flex;gap:6px;align-items:center"><input type="checkbox" id="schNotify"> Уведомить группу</label>
      <div>
        <button id="addScheduleEvent" class="btn-main">Добавить</button>
        <button id="loadScheduleBtn" class="btn btn-outline-secondary">Обновить</button>
      </div>
    </div>

    <div id="scheduleList">
      <div class="small-muted">Загрузите расписание недели, чтобы редактировать события.</div>
    </div>
  </div>
</div>

<script>
/* ======= Поставь здесь свой WebApp URL ======= */
const gasUrl = 'https://script.google.com/macros/s/AKfycbyI17STyEsL6vYDBX1d98YElOk9O7KWTwMUL7DxOulDzSkgPXLASnNCfsA1GvNWfM_fEA/exec';
/* ============================================ */

let allChildren = [];
let scheduleCache = [];

// helpers
function esc(s){ if(s===undefined||s===null) return ''; return String(s).replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
function byId(id){ return document.getElementById(id); }

/* Tabs */
document.querySelectorAll('.tab-btn').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    const tab = btn.dataset.tab;
    byId('attendance').style.display = tab === 'attendance' ? '' : 'none';
    byId('distribution').style.display = tab === 'distribution' ? '' : 'none';
    byId('schedule').style.display = tab === 'schedule' ? '' : 'none';
  });
});

/* Init */
(function init(){
  loadAllChildren();
  loadSchedule();
})();

/* ----------------- Load children ----------------- */
async function loadAllChildren(){
  byId('distributionList').innerHTML = 'Загрузка...';
  try {
    const resp = await fetch(`${gasUrl}?action=getAllChildren`);
    const data = await resp.json();
    if (!data.success) throw new Error('Ошибка сервера');
    allChildren = data.children || [];
    renderDistributionList();
    return allChildren;
  } catch (err) {
    console.error(err);
    byId('distributionList').innerHTML = '<div class="small-muted text-danger">Ошибка загрузки детей</div>';
  }
}
byId('loadAllChildren').addEventListener('click', loadAllChildren);

/* ----- Distribution ----- */
function renderDistributionList(){
  const q = (byId('distSearch').value || '').trim().toLowerCase();
  const items = allChildren.filter(c => {
    if (!q) return true;
    return (c.childName || '').toLowerCase().includes(q) || (c.telegramID || '').includes(q);
  });
  const wrap = byId('distributionList');
  if (!items.length) { wrap.innerHTML = '<div class="small-muted">Нет записей</div>'; return; }
  wrap.innerHTML = items.map(c => {
    return `<div class="student-row" data-tg="${esc(c.telegramID)}" data-name="${esc(c.childName)}">
      <div class="student-left">
        <div class="initials">${esc((c.childName||'').slice(0,2).toUpperCase())}</div>
        <div>
          <div style="font-weight:700">${esc(c.childName)}</div>
          <div class="small-info">ID: ${esc(c.telegramID)} • Осталось: ${Number(c.remaining||0)} • Отработок: ${Number(c.extra||0)}</div>
        </div>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <select class="select group-select" data-tg="${esc(c.telegramID)}" data-name="${esc(c.childName)}">
          <option value="">— Нераспр. —</option>
          <option value="Новые школьники" ${c.group==='Новые школьники'?'selected':''}>Новые школьники</option>
          <option value="Дошкольники" ${c.group==='Дошкольники'?'selected':''}>Дошкольники</option>
          <option value="Старшая группа" ${c.group==='Старшая группа'?'selected':''}>Старшая группа</option>
        </select>
        <button class="btn-ghost btn-save-group" data-tg="${esc(c.telegramID)}" data-name="${esc(c.childName)}">Сохранить</button>
      </div>
    </div>`;
  }).join('');
  // attach handlers
  document.querySelectorAll('.btn-save-group').forEach(b=>{
    b.addEventListener('click', async ()=>{
      const tg = b.dataset.tg;
      const name = b.dataset.name;
      const sel = document.querySelector(`select[data-tg="${CSS.escape(tg)}"][data-name="${CSS.escape(name)}"]`);
      const group = sel ? sel.value : '';
      await setGroupAPI(tg, decodeURIComponent(name), group);
      await loadAllChildren();
      alert('Группа назначена');
    });
  });
}
byId('distSearch').addEventListener('input', renderDistributionList);

/* setGroup API */
async function setGroupAPI(telegramID, childName, group){
  try {
    const body = new URLSearchParams();
    body.append('action','setGroup');
    body.append('telegramID', telegramID);
    body.append('childName', childName);
    body.append('group', group);
    const resp = await fetch(gasUrl, { method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded;charset=UTF-8'}, body: body.toString() });
    const res = await resp.json();
    if (!res.success) throw new Error(res.message || 'Ошибка setGroup');
    return res;
  } catch (err) { console.error(err); alert('Ошибка назначения группы'); }
}

/* ------------- ATTENDANCE (filter by group) ------------- */
byId('loadGroupStudents').addEventListener('click', async ()=>{
  const group = byId('attGroup').value;
  if (!allChildren.length) await loadAllChildren();
  const filtered = allChildren.filter(c => {
    if (!group) return true; // all groups
    if (group === 'unassigned') return !c.group || c.group === '';
    return c.group === group;
  });
  renderAttendanceList(filtered);
});

function renderAttendanceList(children){
  const wrap = byId('attendanceList');
  if (!children || !children.length) { wrap.innerHTML = '<div class="small-muted">Нет детей в группе</div>'; return; }
  wrap.innerHTML = children.map(c => {
    return `<div class="student-row" data-tg="${esc(c.telegramID)}" data-name="${esc(c.childName)}" data-remaining="${Number(c.remaining||0)}" data-extra="${Number(c.extra||0)}">
      <div class="student-left" style="min-width:0">
        <div class="initials">${esc((c.childName||'').slice(0,2).toUpperCase())}</div>
        <div style="min-width:0">
          <div style="font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${esc(c.childName)}</div>
          <div class="small-info">ID: ${esc(c.telegramID)}</div>
          <div class="small-info">Баланс: <strong class="rem-val">${Number(c.remaining||0)}</strong> • Отработок: <strong class="extra-val">${Number(c.extra||0)}</strong></div>
        </div>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <div style="display:flex;flex-direction:column;align-items:center">
          <div style="font-size:12px;color:var(--muted);margin-bottom:6px">Занятия</div>
          <div class="counter-col">
            <button class="counter-btn rem-dec" title="Убавить занятие">−</button>
            <div style="min-width:36px;text-align:center" class="rem-val-display">${Number(c.remaining||0)}</div>
            <button class="counter-btn rem-inc" title="Добавить занятие">+</button>
          </div>
        </div>

        <div style="display:flex;flex-direction:column;align-items:center">
          <div style="font-size:12px;color:var(--muted);margin-bottom:6px">Отработки</div>
          <div class="counter-col">
            <button class="counter-btn extra-dec" title="Убавить отработку">−</button>
            <div style="min-width:36px;text-align:center" class="extra-val-display">${Number(c.extra||0)}</div>
            <button class="counter-btn extra-inc" title="Добавить отработку">+</button>
          </div>
        </div>
      </div>
    </div>`;
  }).join('');

  // attach handlers for each rendered row
  document.querySelectorAll('#attendanceList .student-row').forEach(row=>{
    const tg = row.dataset.tg;
    const name = row.dataset.name;

    const remDec = row.querySelector('.rem-dec');
    const remInc = row.querySelector('.rem-inc');
    const extraDec = row.querySelector('.extra-dec');
    const extraInc = row.querySelector('.extra-inc');
    const remValDisplay = row.querySelector('.rem-val-display');
    const extraValDisplay = row.querySelector('.extra-val-display');

    // Helper to update local cache and display (optimistic)
    function updateLocalAndDisplay(delta, displayEl, valKey) {
      const child = allChildren.find(c => String(c.telegramID) === String(tg) && c.childName === name);
      if (!child) return;
      child[valKey] = Math.max(0, Number(child[valKey] || 0) + delta);
      displayEl.textContent = child[valKey];
    }

    // Optimistic dec remaining
    remDec.addEventListener('click', async ()=>{
      const child = allChildren.find(c => String(c.telegramID) === String(tg) && c.childName === name);
      if (!child) return;
      const backupRem = Number(child.remaining || 0);
      updateLocalAndDisplay(-1, remValDisplay, 'remaining');
      try {
        await callIncDec('decRemaining', tg, name);
      } catch (err) {
        // Rollback on error
        child.remaining = backupRem;
        remValDisplay.textContent = backupRem;
        alert('Ошибка сохранения, значение откатилось');
        console.error(err);
      }
    });

    // Optimistic inc remaining
    remInc.addEventListener('click', async ()=>{
      const child = allChildren.find(c => String(c.telegramID) === String(tg) && c.childName === name);
      if (!child) return;
      const backupRem = Number(child.remaining || 0);
      updateLocalAndDisplay(+1, remValDisplay, 'remaining');
      try {
        await callIncDec('incRemaining', tg, name);
      } catch (err) {
        // Rollback on error
        child.remaining = backupRem;
        remValDisplay.textContent = backupRem;
        alert('Ошибка сохранения, значение откатилось');
        console.error(err);
      }
    });

    // Optimistic dec extra
    extraDec.addEventListener('click', async ()=>{
      const child = allChildren.find(c => String(c.telegramID) === String(tg) && c.childName === name);
      if (!child) return;
      const backupExtra = Number(child.extra || 0);
      updateLocalAndDisplay(-1, extraValDisplay, 'extra');
      try {
        await callIncDec('decExtra', tg, name);
      } catch (err) {
        // Rollback on error
        child.extra = backupExtra;
        extraValDisplay.textContent = backupExtra;
        alert('Ошибка сохранения, значение откатилось');
        console.error(err);
      }
    });

    // Optimistic inc extra
    extraInc.addEventListener('click', async ()=>{
      const child = allChildren.find(c => String(c.telegramID) === String(tg) && c.childName === name);
      if (!child) return;
      const backupExtra = Number(child.extra || 0);
      updateLocalAndDisplay(+1, extraValDisplay, 'extra');
      try {
        await callIncDec('incExtra', tg, name);
      } catch (err) {
        // Rollback on error
        child.extra = backupExtra;
        extraValDisplay.textContent = backupExtra;
        alert('Ошибка сохранения, значение откатилось');
        console.error(err);
      }
    });
  });
}

/* call inc/dec endpoints */
async function callIncDec(action, telegramID, childName){
  try {
    const body = new URLSearchParams();
    body.append('action', action);
    body.append('telegramID', telegramID);
    body.append('childName', childName);
    const resp = await fetch(gasUrl, { method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded;charset=UTF-8'}, body: body.toString() });
    const res = await resp.json();
    if (!res.success && typeof res.success !== 'undefined') throw new Error('incDec failed');
    return res;
  } catch (err) { console.error(err); throw err; } // Re-throw for rollback
}

/* ---------------- Schedule ---------------- */
byId('loadScheduleBtn').addEventListener('click', loadSchedule);
byId('addScheduleEvent').addEventListener('click', async ()=>{
  const weekday = byId('schWeekday').value;
  const group = byId('schGroup').value;
  const startTime = byId('schStartTime').value;
  const endTime = byId('schEndTime').value;
  const time = startTime && endTime ? `${startTime} — ${endTime}` : '';
  const note = byId('schNote').value;
  const notify = byId('schNotify').checked;
  if (!time || group===undefined) return alert('Заполните группу и время');
  try {
    const body = new URLSearchParams();
    body.append('action','setSchedule');
    body.append('mode','add');
    body.append('weekday', weekday);
    body.append('group', group);
    body.append('time', time);
    body.append('note', note);
    const resp = await fetch(gasUrl, { method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded;charset=UTF-8'}, body: body.toString() });
    const res = await resp.json();
    if (!res.success) throw new Error(res.message||'Ошибка добавления');
    // if notify checked -> ask for message and call notifyGroupChange
    if (notify) {
      const message = prompt('Сообщение для группы (будет отправлено родителям):', `В расписании произошли изменения — проверьте обновлённое время для группы ${group}.`);
      if (message !== null) {
        const b2 = new URLSearchParams();
        b2.append('action','notifyGroupChange');
        b2.append('group', group);
        b2.append('message', message);
        await fetch(gasUrl, { method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded;charset=UTF-8'}, body: b2.toString() });
        alert('Уведомление отправлено (если у родителей открыт диалог с ботом).');
      }
    }
    await loadSchedule();
  } catch (err) { console.error(err); alert('Ошибка добавления занятия'); }
});

async function loadSchedule(){
  byId('scheduleList').innerHTML = '<div class="small-muted">Загрузка...</div>';
  try {
    const resp = await fetch(`${gasUrl}?action=getSchedule`);
    const data = await resp.json();
    if (!data.success) throw new Error('Ошибка сервера');
    scheduleCache = data.schedule || [];
    renderSchedule();
  } catch (err) { console.error(err); byId('scheduleList').innerHTML = '<div class="small-muted text-danger">Ошибка загрузки расписания</div>'; }
}

function renderSchedule(){
  const wrap = byId('scheduleList');
  if (!scheduleCache.length) { wrap.innerHTML = '<div class="small-muted">Расписание пустое</div>'; return; }
  const byDay = {};
  scheduleCache.forEach(s => { const wd = String(s.weekday||'0'); if (!byDay[wd]) byDay[wd]=[]; byDay[wd].push(s); });
  const order = [1,2,3,4,5,6,0];
  wrap.innerHTML = order.map(d=>{
    const items = byDay[String(d)] || [];
    if (!items.length) return '';
    return `<div class="day-section">
      <div class="day-header">${weekdayName(d)} (${items.length})</div>
      <div>${items.map(it=>`
        <div class="student-row" data-id="${esc(it.id)}">
          <div class="event-info">
            <div style="font-weight:700">${esc(it.group)}</div>
            <div class="small-muted">${esc(it.time)} ${it.note ? ' • '+esc(it.note):''}</div>
          </div>
          <div class="event-actions">
            <button class="btn-ghost btn-edit-event" data-id="${esc(it.id)}">Править</button>
            <button class="btn-ghost btn-del-event" data-id="${esc(it.id)}">Удалить</button>
            <button class="btn-main btn-notify-group" data-group="${esc(it.group)}" style="font-size:14px">Уведомить</button>
          </div>
        </div>
      `).join('')}</div>
    </div>`;
  }).join('');
  // attach
  document.querySelectorAll('.btn-edit-event').forEach(b=>b.addEventListener('click', async ()=>{
    const id = b.dataset.id;
    const ev = scheduleCache.find(x=>x.id===id);
    if (!ev) return alert('Событие не найдено');
    const newGroup = prompt('Группа', ev.group) || ev.group;
    const newStart = prompt('Начало (HH:MM)', ev.time.split(' — ')[0]) || ev.time.split(' — ')[0];
    const newEnd = prompt('Конец (HH:MM)', ev.time.split(' — ')[1]) || ev.time.split(' — ')[1];
    const newTime = `${newStart} — ${newEnd}`;
    const newNote = prompt('Заметка', ev.note||'') || ev.note||'';
    try {
      const body = new URLSearchParams();
      body.append('action','setSchedule'); body.append('mode','update'); body.append('id', id);
      body.append('weekday', ev.weekday); body.append('group', newGroup); body.append('time', newTime); body.append('note', newNote);
      const resp = await fetch(gasUrl, { method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded;charset=UTF-8'}, body: body.toString() });
      const res = await resp.json();
      if (!res.success) throw new Error(res.message||'Ошибка');
      const notify = confirm('Отправить уведомление группе об изменении?');
      if (notify) {
        const message = prompt('Сообщение для группы', `В расписании группы ${newGroup} произошли изменения. Проверьте новое время.`);
        if (message !== null) {
          const b2 = new URLSearchParams(); b2.append('action','notifyGroupChange'); b2.append('group', newGroup); b2.append('message', message);
          await fetch(gasUrl, { method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded;charset=UTF-8'}, body: b2.toString() });
          alert('Уведомление отправлено');
        }
      }
      await loadSchedule();
    } catch (err){ console.error(err); alert('Ошибка обновления'); }
  }));
  document.querySelectorAll('.btn-del-event').forEach(b=>b.addEventListener('click', async ()=>{
    const id = b.dataset.id;
    if (!confirm('Удалить событие?')) return;
    try {
      const body = new URLSearchParams(); body.append('action','setSchedule'); body.append('mode','delete'); body.append('id', id);
      const resp = await fetch(gasUrl, { method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded;charset=UTF-8'}, body: body.toString() });
      const res = await resp.json();
      if (!res.success) throw new Error(res.message||'Ошибка');
      const notify = confirm('Отправить уведомление группе об удалении?');
      if (notify) {
        const group = b.parentElement.querySelector('.btn-notify-group')?.dataset.group || '';
        const message = prompt('Сообщение для группы', `Занятие было удалено из расписания группы ${group}.`);
        if (message !== null) {
          const b2 = new URLSearchParams(); b2.append('action','notifyGroupChange'); b2.append('group', group); b2.append('message', message);
          await fetch(gasUrl, { method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded;charset=UTF-8'}, body: b2.toString() });
          alert('Уведомление отправлено');
        }
      }
      await loadSchedule();
    } catch (err) { console.error(err); alert('Ошибка удаления'); }
  }));
  document.querySelectorAll('.btn-notify-group').forEach(b=>b.addEventListener('click', async ()=>{
    const group = b.dataset.group;
    const message = prompt('Сообщение для группы ' + group, 'В расписании произошли изменения. Проверьте новое время занятий.');
    if (message === null) return;
    try {
      const body = new URLSearchParams(); body.append('action','notifyGroupChange'); body.append('group', group); body.append('message', message);
      const resp = await fetch(gasUrl, { method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded;charset=UTF-8'}, body: body.toString() });
      const res = await resp.json();
      if (!res.success) throw new Error(res.message || 'Ошибка отправки');
      alert('Уведомлено: ' + res.count);
    } catch (err) { console.error(err); alert('Ошибка уведомления'); }
  }));
}

function weekdayName(n){ return {0:'Воскресенье',1:'Понедельник',2:'Вторник',3:'Среда',4:'Четверг',5:'Пятница',6:'Суббота'}[n]||''; }

</script>
</body>
</html>
