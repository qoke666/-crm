<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CRM для тренера</title>
  <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background: #1F2937;
      color: #F3F4F6;
      margin: 0;
      overflow-y: auto;
    }
    .menu {
      display: flex;
      justify-content: center;
      background: rgba(31, 41, 55, 0.9);
      backdrop-filter: blur(8px);
      padding: 6px 0;
      position: sticky;
      top: 0;
      z-index: 10;
    }
    .menu ul {
      display: inline-flex;
      gap: 10px;
      padding: 0 16px;
    }
    .menu-item {
      padding: 6px 12px;
      border-radius: 6px;
      font-family: 'Inter', sans-serif;
      font-weight: 600;
      font-size: 14px;
      cursor: pointer;
      color: #6B7280;
      transition: background 0.3s, color 0.3s, transform 0.3s;
    }
    .menu-item.active,
    .menu-item:hover {
      background: #14B8A6;
      color: #F3F4F6;
      transform: scale(1.05);
    }
    .section {
      display: none;
      padding: 8px 16px;
      box-sizing: border-box;
    }
    .section.active {
      display: block;
    }
    .section-title {
      font-family: 'Inter', sans-serif;
      font-size: 24px;
      font-weight: 700;
      margin: 8px 0;
      color: #14B8A6;
      text-align: center;
    }
    .card {
      background: linear-gradient(135deg, rgba(31, 41, 55, 0.5), rgba(55, 65, 81, 0.3));
      backdrop-filter: blur(8px);
      border: 1px solid rgba(20, 184, 166, 0.3);
      border-radius: 12px;
      padding: 12px;
      color: #6B7280;
      transition: transform 0.3s ease, box-shadow 0.3s ease, border-color 0.3s ease;
    }
    .card:hover {
      transform: scale(1.03);
      box-shadow: 0 6px 16px rgba(20, 184, 166, 0.4);
      border-color: rgba(20, 184, 166, 0.5);
    }
    .group-tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 12px;
      background: rgba(243, 244, 246, 0.05);
      border-radius: 6px;
      padding: 4px;
    }
    .group-tab {
      flex: 1;
      padding: 6px;
      text-align: center;
      font-family: 'Inter', sans-serif;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      color: #6B7280;
      border-radius: 4px;
      transition: background 0.3s, color 0.3s;
    }
    .group-tab.active,
    .group-tab:hover {
      background: #14B8A6;
      color: #F3F4F6;
    }
    .modal {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) scale(0.7);
      background: linear-gradient(135deg, rgba(31, 41, 55, 0.85), rgba(55, 65, 81, 0.65));
      backdrop-filter: blur(12px);
      border: 1px solid rgba(20, 184, 166, 0.4);
      border-radius: 16px;
      padding: 16px;
      z-index: 9999;
      color: #F3F4F6;
      max-width: 95%;
      min-width: 300px;
      max-height: 98vh;
      overflow-y: auto;
      opacity: 0;
      transition: transform 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55), opacity 0.6s ease;
    }
    .modal.active {
      transform: translate(-50%, -50%) scale(1);
      opacity: 1;
    }
    body.modal-open {
      overflow: hidden;
    }
    body.modal-open::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(10px);
      z-index: 9998;
      opacity: 0;
      transition: opacity 0.6s ease;
    }
    body.modal-open::before {
      opacity: 1;
    }
    .modal h3 {
      font-family: 'Inter', sans-serif;
      margin: 0 0 10px;
      color: #14B8A6;
      font-size: 18px;
      text-align: center;
    }
    .modal .apply-form {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-top: 10px;
    }
    .modal .apply-form label {
      font-size: 13px;
      color: #6B7280;
    }
    .modal .apply-form input,
    .modal .apply-form select {
      padding: 5px;
      border: 1px solid #4B5563;
      border-radius: 5px;
      background: #374151;
      color: #F3F4F6;
      font-family: 'Inter', sans-serif;
      font-size: 13px;
      width: 100%;
    }
    .modal .apply-form select {
      appearance: none;
      background-image: url('data:image/svg+xml;utf8,<svg fill="%236B7280" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M7 10l5 5 5-5z"/></svg>');
      background-repeat: no-repeat;
      background-position: right 5px center;
      background-size: 12px;
    }
    .modal .apply-form button {
      padding: 5px 12px;
      background: #14B8A6;
      color: #F3F4F6;
      border: none;
      border-radius: 5px;
      font-family: 'Inter', sans-serif;
      font-weight: 600;
      font-size: 13px;
      cursor: pointer;
      transition: background 0.3s ease, transform 0.3s ease;
    }
    .modal .apply-form button:hover {
      background: #F28C38;
      transform: scale(1.05);
    }
    .modal .close-button {
      padding: 5px 12px;
      background: #4B5563;
      color: #F3F4F6;
      border: 1px solid #6B7280;
      border-radius: 5px;
      font-weight: 600;
      font-size: 13px;
      margin-top: 5px;
      transition: background 0.3s ease, transform 0.3s ease;
    }
    .modal .close-button:hover {
      background: #6B7280;
      transform: scale(1.05);
    }
    .modal .spinner {
      border: 3px solid rgba(20, 184, 166, 0.2);
      border-top: 3px solid #14B8A6;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      animation: spin 1s linear infinite;
      margin: 12px auto;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .list-item {
      padding: 8px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid rgba(243, 244, 246, 0.1);
    }
    .list-item:last-child {
      border-bottom: none;
    }
    .list-item:hover {
      background: rgba(243, 244, 246, 0.05);
    }
  </style>
</head>
<body>
  <nav class="menu">
    <ul>
      <li class="menu-item active" data-section="ratings">Рейтинги</li>
      <li class="menu-item" data-section="finances">Финансы</li>
      <li class="menu-item" data-section="analytics">Аналитика</li>
    </ul>
  </nav>

  <section id="ratings" class="section active">
    <h2 class="section-title">Рейтинги учеников</h2>
    <div class="group-tabs">
      <button class="group-tab active" data-group="junior">Младшая</button>
      <button class="group-tab" data-group="middle">Средняя</button>
      <button class="group-tab" data-group="senior">Старшая</button>
    </div>
    <div class="card" data-aos="fade-up" data-aos-delay="100">
      <div class="rating-list" id="rating-list"></div>
    </div>
  </section>

  <section id="finances" class="section">
    <h2 class="section-title">Финансы</h2>
    <div class="card" data-aos="fade-up" data-aos-delay="100">
      <h3 class="text-lg font-semibold mb-4 text-white">Добавить расход</h3>
      <div class="apply-form">
        <label>Ученик</label>
        <select id="expense-student">
          <option value="">Выберите ученика</option>
        </select>
        <label>Сумма (₽)</label>
        <input type="number" id="expense-amount" placeholder="Введите сумму">
        <label>Описание</label>
        <input type="text" id="expense-description" placeholder="Введите описание">
        <button onclick="addExpense()"><i class="fas fa-plus"></i> Добавить</button>
      </div>
    </div>
    <div class="card" data-aos="fade-up" data-aos-delay="150">
      <h3 class="text-lg font-semibold mb-4 text-white">Доходы</h3>
      <div id="payments-list"></div>
    </div>
    <div class="card" data-aos="fade-up" data-aos-delay="200">
      <h3 class="text-lg font-semibold mb-4 text-white">Расходы</h3>
      <div id="expenses-list"></div>
    </div>
  </section>

  <section id="analytics" class="section">
    <h2 class="section-title">Аналитика</h2>
    <div class="card" data-aos="fade-up" data-aos-delay="100">
      <label class="block text-sm text-gray-400 mb-2">Выберите ученика</label>
      <select id="analytics-student" onchange="updateAnalytics()">
        <option value="">Выберите ученика</option>
      </select>
    </div>
    <div id="analytics-content" class="space-y-4"></div>
  </section>

  <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
  <script>
    AOS.init({ duration: 800, once: true, offset: 100 });

    let students = [];
    let bookings = [];
    let payments = [];
    let expenses = [];

    async function fetchData() {
      try {
        const response = await fetch('https://script.google.com/macros/s/AKfycbwC3edBRYfhE66VimHG0khgvY5eTttJYq6kRGKs3GFc_Gh7PSNdHXViuRGhuXalaI6A7A/exec', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ action: 'getData' })
        });
        const data = await response.json();
        if (data.status === 'success') {
          students = data.ratings || [];
          bookings = data.bookings || [];
          payments = data.payments || [];
          expenses = data.expenses || [];
          updateRating('junior');
          updateFinanceLists();
          populateStudentSelects();
        } else {
          alert('Ошибка загрузки данных: ' + data.message);
        }
      } catch (error) {
        alert('Ошибка загрузки данных: ' + error.message);
      }
    }

    function populateStudentSelects() {
      const expenseSelect = document.getElementById('expense-student');
      const analyticsSelect = document.getElementById('analytics-student');
      expenseSelect.innerHTML = '<option value="">Выберите ученика</option>';
      analyticsSelect.innerHTML = '<option value="">Выберите ученика</option>';
      students.forEach(student => {
        const option1 = document.createElement('option');
        option1.value = student.id;
        option1.textContent = student.name;
        expenseSelect.appendChild(option1);
        const option2 = document.createElement('option');
        option2.value = student.id;
        option2.textContent = student.name;
        analyticsSelect.appendChild(option2);
      });
    }

    function updateRating(group) {
      const container = document.getElementById('rating-list');
      container.innerHTML = '';
      const filteredStudents = students.filter(student => student.group === group);
      if (filteredStudents.length === 0) {
        container.innerHTML = '<p class="text-gray-400">Нет данных для этой группы</p>';
        return;
      }
      filteredStudents.forEach(student => {
        const div = document.createElement('div');
        div.className = 'list-item';
        div.innerHTML = `
          <div class="flex items-center gap-2">
            <div class="text-sm font-semibold ${
              student.rank === 1 ? 'text-yellow-400' :
              student.rank === 2 ? 'text-gray-300' :
              student.rank === 3 ? 'text-amber-500' : 'text-gray-400'
            }">${student.rank}</div>
            <div class="w-4 h-2 rounded border ${
              student.belt === 'white' ? 'bg-gray-100 border-gray-300' :
              student.belt === 'yellow' ? 'bg-yellow-400 border-yellow-500' :
              student.belt === 'orange' ? 'bg-orange-400 border-orange-500' :
              student.belt === 'green' ? 'bg-emerald-400 border-emerald-500' :
              student.belt === 'blue' ? 'bg-blue-400 border-blue-500' :
              'bg-amber-600 border-amber-700'
            }"></div>
            <div class="flex-1">
              <div class="text-sm font-semibold">${student.name}</div>
              <div class="text-xs text-gray-400">${student.points} очков</div>
            </div>
          </div>
          <button class="bg-teal-500 text-white px-4 py-1 rounded hover:bg-orange-500 transition" onclick="openRatingModal('${student.id}')">Редактировать</button>
        `;
        container.appendChild(div);
      });
    }

    function openRatingModal(studentId) {
      const student = students.find(s => s.id === studentId);
      const modal = document.createElement('div');
      modal.className = 'modal';
      modal.innerHTML = `
        <h3>Редактировать рейтинг: ${student.name}</h3>
        <div class="apply-form">
          <label>Очки</label>
          <input type="number" id="points" value="${student.points}">
          <label>Пояс</label>
          <select id="belt">
            <option value="white" ${student.belt === 'white' ? 'selected' : ''}>Белый</option>
            <option value="yellow" ${student.belt === 'yellow' ? 'selected' : ''}>Жёлтый</option>
            <option value="orange" ${student.belt === 'orange' ? 'selected' : ''}>Оранжевый</option>
            <option value="green" ${student.belt === 'green' ? 'selected' : ''}>Зелёный</option>
            <option value="blue" ${student.belt === 'blue' ? 'selected' : ''}>Синий</option>
            <option value="brown" ${student.belt === 'brown' ? 'selected' : ''}>Коричневый</option>
          </select>
          <button onclick="updateRating('${studentId}')"><i class="fas fa-save"></i> Сохранить</button>
          <button class="close-button"><i class="fas fa-times"></i> Отмена</button>
        </div>
      `;
      document.body.appendChild(modal);
      setTimeout(() => modal.classList.add('active'), 10);
      document.body.classList.add('modal-open');

      modal.querySelector('.close-button').addEventListener('click', () => {
        modal.classList.remove('active');
        document.body.classList.remove('modal-open');
        setTimeout(() => modal.remove(), 600);
      });
    }

    async function updateRating(studentId) {
      const points = parseInt(document.getElementById('points').value);
      const belt = document.getElementById('belt').value;
      if (points < 0) {
        alert('Очки не могут быть отрицательными');
        return;
      }
      const modal = document.querySelector('.modal');
      modal.querySelector('.apply-form').innerHTML = `<div class="spinner"></div>`;
      try {
        const response = await fetch('https://script.google.com/macros/s/AKfycbwC3edBRYfhE66VimHG0khgvY5eTttJYq6kRGKs3GFc_Gh7PSNdHXViuRGhuXalaI6A7A/exec', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            action: 'updateRating',
            studentId,
            points,
            belt
          })
        });
        const result = await response.json();
        if (result.status === 'success') {
          await fetchData();
          modal.querySelector('.apply-form').innerHTML = `
            <p style="text-align: center; font-size: 18px; color: #14B8A6;">Рейтинг обновлен!</p>
            <button class="close-button"><i class="fas fa-times"></i> Закрыть</button>
          `;
          modal.querySelector('.close-button').addEventListener('click', () => {
            modal.classList.remove('active');
            document.body.classList.remove('modal-open');
            setTimeout(() => modal.remove(), 600);
          });
        } else {
          throw new Error(result.message);
        }
      } catch (error) {
        modal.querySelector('.apply-form').innerHTML = `
          <p style="text-align: center; font-size: 18px; color: #EF4444;">Ошибка: ${error.message}</p>
          <button class="close-button"><i class="fas fa-times"></i> Закрыть</button>
        `;
        modal.querySelector('.close-button').addEventListener('click', () => {
          modal.classList.remove('active');
          document.body.classList.remove('modal-open');
          setTimeout(() => modal.remove(), 600);
        });
      }
    }

    async function addExpense() {
      const studentId = document.getElementById('expense-student').value;
      const amount = parseFloat(document.getElementById('expense-amount').value);
      const description = document.getElementById('expense-description').value;
      if (!studentId || !amount || amount <= 0 || !description) {
        alert('Заполните все поля корректно');
        return;
      }
      const form = document.querySelector('#finances .apply-form');
      form.innerHTML = `<div class="spinner"></div>`;
      try {
        const response = await fetch('https://script.google.com/macros/s/AKfycbwC3edBRYfhE66VimHG0khgvY5eTttJYq6kRGKs3GFc_Gh7PSNdHXViuRGhuXalaI6A7A/exec', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            action: 'addExpense',
            studentId,
            name: students.find(s => s.id === studentId).name,
            amount,
            description,
            date: new Date().toISOString().split('T')[0]
          })
        });
        const result = await response.json();
        if (result.status === 'success') {
          await fetchData();
          form.innerHTML = `
            <p style="text-align: center; font-size: 18px; color: #14B8A6;">Расход добавлен!</p>
            <button class="close-button" onclick="resetExpenseForm()"><i class="fas fa-times"></i> Закрыть</button>
          `;
        } else {
          throw new Error(result.message);
        }
      } catch (error) {
        form.innerHTML = `
          <p style="text-align: center; font-size: 18px; color: #EF4444;">Ошибка: ${error.message}</p>
          <button class="close-button" onclick="resetExpenseForm()"><i class="fas fa-times"></i> Закрыть</button>
        `;
      }
    }

    function resetExpenseForm() {
      const form = document.querySelector('#finances .apply-form');
      form.innerHTML = `
        <label>Ученик</label>
        <select id="expense-student">
          <option value="">Выберите ученика</option>
        </select>
        <label>Сумма (₽)</label>
        <input type="number" id="expense-amount" placeholder="Введите сумму">
        <label>Описание</label>
        <input type="text" id="expense-description" placeholder="Введите описание">
        <button onclick="addExpense()"><i class="fas fa-plus"></i> Добавить</button>
      `;
      populateStudentSelects();
    }

    function updateFinanceLists() {
      const paymentsList = document.getElementById('payments-list');
      const expensesList = document.getElementById('expenses-list');
      paymentsList.innerHTML = payments.length === 0
        ? '<p class="text-gray-400">Нет данных о доходах</p>'
        : payments.map(p => `<div class="list-item"><div class="text-sm">${p.name}: ${p.amount} ₽ (${p.plan}, ${p.date})</div></div>`).join('');
      expensesList.innerHTML = expenses.length === 0
        ? '<p class="text-gray-400">Нет данных о расходах</p>'
        : expenses.map(e => `<div class="list-item"><div class="text-sm">${e.name}: ${e.amount} ₽ (${e.description}, ${e.date})</div></div>`).join('');
    }

    function updateAnalytics() {
      const studentId = document.getElementById('analytics-student').value;
      const content = document.getElementById('analytics-content');
      if (!studentId) {
        content.innerHTML = '';
        return;
      }
      const student = students.find(s => s.id === studentId);
      const studentBookings = bookings.filter(b => b.childName === student.name);
      const studentPayments = payments.filter(p => p.name === student.name);
      const studentExpenses = expenses.filter(e => e.studentId === studentId);
      const totalIncome = studentPayments.reduce((sum, p) => sum + parseFloat(p.amount), 0);
      const totalExpenses = studentExpenses.reduce((sum, e) => sum + parseFloat(e.amount), 0);

      content.innerHTML = `
        <div class="card" data-aos="fade-up" data-aos-delay="100">
          <h3 class="text-lg font-semibold mb-4 text-white">Общая информация</h3>
          <p class="text-sm">Имя: ${student.name}</p>
          <p class="text-sm">Группа: ${student.group === 'junior' ? 'Младшая' : student.group === 'middle' ? 'Средняя' : 'Старшая'}</p>
          <p class="text-sm">Пояс: ${student.belt}</p>
          <p class="text-sm">Очки: ${student.points}</p>
          <p class="text-sm">Рейтинг: ${student.rank}</p>
        </div>
        <div class="card" data-aos="fade-up" data-aos-delay="150">
          <h3 class="text-lg font-semibold mb-4 text-white">Посещаемость</h3>
          ${studentBookings.length === 0 ? '<p class="text-gray-400">Нет записей на занятия</p>' : 
            studentBookings.map(b => `<div class="list-item"><div class="text-sm">Дата: ${b.date}, Группа: ${b.group}</div></div>`).join('')}
        </div>
        <div class="card" data-aos="fade-up" data-aos-delay="200">
          <h3 class="text-lg font-semibold mb-4 text-white">Финансы</h3>
          <p class="text-sm">Доходы: ${totalIncome} ₽</p>
          <p class="text-sm">Расходы: ${totalExpenses} ₽</p>
          <p class="text-sm">Баланс: ${totalIncome - totalExpenses} ₽</p>
          <h4 class="text-md font-semibold mt-4 text-white">История платежей</h4>
          ${studentPayments.length === 0 ? '<p class="text-gray-400">Нет платежей</p>' : 
            studentPayments.map(p => `<div class="list-item"><div class="text-sm">${p.amount} ₽ (${p.plan}, ${p.date})</div></div>`).join('')}
          <h4 class="text-md font-semibold mt-4 text-white">История расходов</h4>
          ${studentExpenses.length === 0 ? '<p class="text-gray-400">Нет расходов</p>' : 
            studentExpenses.map(e => `<div class="list-item"><div class="text-sm">${e.amount} ₽ (${e.description}, ${e.date})</div></div>`).join('')}
        </div>
      `;
      AOS.refresh();
    }

    document.querySelectorAll('.menu-item').forEach(item => {
      item.addEventListener('click', () => {
        document.querySelectorAll('.section').forEach(section => {
          section.classList.toggle('active', section.id === item.dataset.section);
        });
        document.querySelectorAll('.menu-item').forEach(i => {
          i.classList.toggle('active', i === item);
        });
        window.scrollTo({ top: 0, behavior: 'smooth' });
      });
    });

    document.querySelectorAll('.group-tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.group-tab').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        updateRating(tab.dataset.group);
      });
    });

    fetchData();
  </script>
</body>
</html>
